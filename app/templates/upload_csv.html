{% extends "base.html" %}

{% block title %}Upload CSV - Roofing Lead Manager{% endblock %}

{% block content %}
<div class="card">
    <h2>Upload Leads via CSV</h2>
    
    {% if success %}
    <div class="alert alert-success">
        <strong>Success</strong>
        CSV processed successfully.<br>
        <strong>Total Rows:</strong> {{ summary.total_rows }}<br>
        <strong>Valid Leads:</strong> {{ summary.valid_rows }}<br>
        <strong>Invalid Rows:</strong> {{ summary.invalid_rows }}<br>
        <strong>Leads Created:</strong> {{ summary.leads_created }}<br>
        <strong>Leads Enqueued:</strong> {{ summary.leads_enqueued }}<br>
        {% if summary.invalid_rows > 0 %}
        <details style="margin-top: 12px;">
            <summary style="cursor: pointer; font-weight: bold;">View Invalid Rows</summary>
            <ul style="margin-top: 10px; margin-left: 20px;">
            {% for invalid in invalid_rows %}
                <li>Row {{ invalid.row }}: {{ invalid.errors }}</li>
            {% endfor %}
            </ul>
        </details>
        {% endif %}
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-error">
        <strong>Error</strong>
        {{ error }}
    </div>
    {% endif %}
    
    {% if not companies %}
    <div class="alert alert-error">
        <strong>No Companies Found</strong>
        You need to register a company first before uploading leads.<br>
        <a href="/register-company">Click here to register a company</a>
    </div>
    {% else %}
    
    <div style="background: #fffbf0; padding: 24px; border: 1px solid #f4e4c1; border-left: 4px solid var(--accent-rust); margin-bottom: 32px;">
        <h4 style="font-family: 'Crimson Pro', serif; color: var(--primary-navy); margin-bottom: 12px; font-size: 1.125rem; font-weight: 600;">CSV Format Requirements</h4>
        <p style="color: var(--text-dark); margin-bottom: 12px; font-size: 0.9rem;">Your CSV file must include the following columns:</p>
        <ul style="color: var(--text-dark); margin-left: 20px; font-size: 0.9rem; line-height: 1.8;">
            <li><strong>name</strong> - Lead's full name (required)</li>
            <li><strong>phone</strong> - Lead's phone number (required)</li>
            <li><strong>notes</strong> - Additional notes (optional)</li>
        </ul>
        <p style="color: var(--text-dark); margin-top: 18px; font-weight: 600; font-size: 0.9rem;">Example CSV:</p>
        <pre style="background: white; padding: 16px; border: 1px solid var(--border-light); overflow-x: auto; margin-top: 8px; font-size: 0.85rem; line-height: 1.6;">name,phone,notes
John Smith,+1-555-1111,Interested in new roof
Mary Johnson,+1-555-2222,Repair needed
Bob Williams,+1-555-3333,Free inspection request</pre>
        <a href="/download-sample-csv" style="display: inline-block; margin-top: 16px; padding: 10px 20px; background: var(--secondary-slate); color: white; text-decoration: none; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase;">Download Sample CSV</a>
    </div>
    
    <form method="POST" action="/upload-csv" enctype="multipart/form-data">
        <div class="form-group">
            <label for="company_id">Select Company <span class="required">*</span></label>
            <select id="company_id" name="company_id" required>
                <option value="">Choose a company</option>
                {% for company in companies %}
                <option value="{{ company.id }}" {% if form_data and form_data.company_id == company.id|string %}selected{% endif %}>
                    {{ company.company_name }} ({{ company.owner_name }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="file">Choose CSV File <span class="required">*</span></label>
            <input type="file" id="file" name="file" accept=".csv" required 
                   style="padding: 16px; border: 2px dashed var(--border-light); background: var(--bg-cream);">
            <small style="display: block; margin-top: 8px;">
                Maximum file size: 10MB
            </small>
        </div>
        
        <button type="submit">Upload CSV</button>
    </form>
    
    {% endif %}
</div>
{% endblock %}
